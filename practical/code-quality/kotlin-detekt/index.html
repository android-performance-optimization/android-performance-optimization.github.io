
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="专注于 Android 性能优化领域，分享基础知识，实战方案，学习路线，技术动态等资源">
      
      
      
        <link rel="canonical" href="https://android-performance-optimization.github.io/practical/code-quality/kotlin-detekt/">
      
      
        <link rel="prev" href="../../compile/now-in-android/">
      
      
        <link rel="next" href="../../stability/airbag/">
      
      <link rel="icon" href="../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.1.16">
    
    
      
        <title>落地 Kotlin 代码规范，DeteKt 了解一下 - Android 性能优化手册</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kotlin-detekt" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Android 性能优化手册" class="md-header__button md-logo" aria-label="Android 性能优化手册" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Android 性能优化手册
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              落地 Kotlin 代码规范，DeteKt 了解一下
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/android-performance-optimization/homepage" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    android-performance-optimization
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        首页
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../../resource/" class="md-tabs__link">
      学习资源
    </a>
  </li>

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../../foundation/self-cultivation/elf-file-detail/" class="md-tabs__link">
        筑基手册
      </a>
    </li>
  

  

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../compile/compile-acceleration/" class="md-tabs__link md-tabs__link--active">
        实战手册
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../2024 - news/2024/news-2024-01.md" class="md-tabs__link">
        技术月报
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Android 性能优化手册" class="md-nav__button md-logo" aria-label="Android 性能优化手册" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 89 89">
  <path d="M3.136,17.387l0,42.932l42.932,21.467l-42.932,-64.399Z" />
  <path d="M21.91,8l42.933,64.398l-18.775,9.388l-42.932,-64.399l18.774,-9.387Z" style="fill-opacity: 0.5" />
  <path d="M67.535,17.387l-27.262,18.156l21.878,32.818l5.384,2.691l0,-53.665Z" />
  <path d="M67.535,17.387l0,53.666l18.774,-9.388l0,-53.665l-18.774,9.387Z" style="fill-opacity: 0.25" />
</svg>

    </a>
    Android 性能优化手册
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/android-performance-optimization/homepage" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    android-performance-optimization
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
      
      
        
          
            
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../..">首页</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          首页
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../intro/htc/" class="md-nav__link">
        如何参与
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../resource/" class="md-nav__link">
        学习资源
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          筑基手册
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          筑基手册
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
          程序员的自我修养
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          程序员的自我修养
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/self-cultivation/elf-file-detail/" class="md-nav__link">
        Elf 文件格式详解
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/self-cultivation/static-link/" class="md-nav__link">
        静态链接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/self-cultivation/elf-load/" class="md-nav__link">
        ELF 文件的装载与进程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/self-cultivation/dynamic-link/" class="md-nav__link">
        动态链接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/self-cultivation/memory/" class="md-nav__link">
        内存
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/self-cultivation/system-call/" class="md-nav__link">
        系统调用
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          Android 系统基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Android 系统基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/framework/activity-start/" class="md-nav__link">
        Activity 启动流程分析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
          实用工具系列
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          实用工具系列
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../foundation/tools/native-hook/" class="md-nav__link">
        Native Hook 快速上手
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          实战手册
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          实战手册
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          编译优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          编译优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../compile/compile-acceleration/" class="md-nav__link">
        编译加速的8个实用技巧
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../compile/now-in-android/" class="md-nav__link">
        nowinandroid 构建脚本学习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" checked>
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
          代码质量优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          代码质量优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          落地 Kotlin 代码规范，DeteKt 了解一下
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        落地 Kotlin 代码规范，DeteKt 了解一下
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    前言
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detekt" class="md-nav__link">
    为什么使用DeteKt?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#idedetekt" class="md-nav__link">
    IDE接入DeteKt插件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clidetekt" class="md-nav__link">
    CLI命令行方式接入DeteKt
  </a>
  
    <nav class="md-nav" aria-label="CLI命令行方式接入DeteKt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    类型解析
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gradledetekt" class="md-nav__link">
    Gradle方式接入DeteKt
  </a>
  
    <nav class="md-nav" aria-label="Gradle方式接入DeteKt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    接入步骤
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detekt_1" class="md-nav__link">
    自定义Detekt检测规则
  </a>
  
    <nav class="md-nav" aria-label="自定义Detekt检测规则">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detekt_2" class="md-nav__link">
    DeteKt自带规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    自定义规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    支持类型解析的自定义规则
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#github-actiondetekt" class="md-nav__link">
    Github Action集成Detekt检测
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    示例代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
          稳定性优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          稳定性优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../stability/airbag/" class="md-nav__link">
        安全气囊如何实现？
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
          速度优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          速度优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../speed/json-serialization-speed/" class="md-nav__link">
        常用 JSON 库性能对比
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../speed/kcp-gson-moshi/" class="md-nav__link">
        使用 KCP 打造更安全的 Gson 与更快的 Moshi
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" >
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
          内存优化
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          内存优化
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../memory/memory-usage-analyse/" class="md-nav__link">
        App 内存占用分析
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          技术月报
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          技术月报
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2024 - news/2024/news-2024-01.md" class="md-nav__link">
        None
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2023 - news/2023/news-2023-12.md - news/2023/news-2023-11.md - news/2023/news-2023-10.md - news/2023/news-2023-09.md - news/2023/news-2023-08.md - news/2023/news-2023-07.md" class="md-nav__link">
        None
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    前言
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detekt" class="md-nav__link">
    为什么使用DeteKt?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#idedetekt" class="md-nav__link">
    IDE接入DeteKt插件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#clidetekt" class="md-nav__link">
    CLI命令行方式接入DeteKt
  </a>
  
    <nav class="md-nav" aria-label="CLI命令行方式接入DeteKt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    类型解析
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gradledetekt" class="md-nav__link">
    Gradle方式接入DeteKt
  </a>
  
    <nav class="md-nav" aria-label="Gradle方式接入DeteKt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    接入步骤
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#detekt_1" class="md-nav__link">
    自定义Detekt检测规则
  </a>
  
    <nav class="md-nav" aria-label="自定义Detekt检测规则">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#detekt_2" class="md-nav__link">
    DeteKt自带规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    自定义规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    支持类型解析的自定义规则
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#github-actiondetekt" class="md-nav__link">
    Github Action集成Detekt检测
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    总结
  </a>
  
    <nav class="md-nav" aria-label="总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    示例代码
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    参考资料
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="kotlin-detekt">落地 Kotlin 代码规范，DeteKt 了解一下</h1>
<h2 id="_1">前言</h2>
<p>各个团队多少都有一些自己的代码规范，但制定代码规范简单，困难的是如何落地。如果完全依赖人力<code>Code Review</code>难免有所遗漏。</p>
<p>这个时候就需要通过静态代码检查工具在每次提交代码时自动检查，本文主要介绍如何使用<code>DeteKt</code>落地<code>Kotlin</code>代码规范，主要包括以下内容</p>
<ol>
<li>为什么使用<code>DeteKt</code>?</li>
<li><code>IDE</code>接入<code>DeteKt</code>插件</li>
<li><code>CLI</code>命令行方式接入<code>DeteKt</code></li>
<li><code>Gradle</code>方式接入<code>DeteKt</code></li>
<li>自定义<code>Detekt</code>检测规则</li>
<li><code>Github Action</code>集成<code>Detekt</code>检测</li>
</ol>
<h2 id="detekt">为什么使用<code>DeteKt</code>?</h2>
<p>说起静态代码检查，大家首先想起来的可能是<code>lint</code>，相比<code>DeteKt</code>只支持<code>Kotlin</code>代码，<code>lint</code>不仅支持<code>Kotlin</code>，<code>Java</code>代码，也支持资源文件规范检查，那么我们为什么不使用<code>Lint</code>呢？</p>
<p>在我看来，<code>Lint</code>在使用上主要有两个问题：   </p>
<ol>
<li>与<code>IDE</code>集成不够好，自定义<code>lint</code>规则的警告只有在运行<code>./gradlew lint</code>后才会在<code>IDE</code>上展示出来，在<code>clean</code>之后又会消失</li>
<li><code>lint</code>检查速度较慢，尤其是大型项目，只对增量代码进行检查的逻辑需要自定义</li>
</ol>
<p>而<code>DeteKt</code>提供了<code>IDE</code>插件，开启后可直接在<code>IDE</code>中查看警告，这样可以在第一时间发现问题，避免后续检查发现问题后再修改流程过长的问题</p>
<p>同时<code>Detekt</code>支持<code>CLI</code>命令行方式接入与<code>Gradle</code>方式接入，支持只检查新增代码，在检查速度上比起<code>lint</code>也有一定的优势</p>
<h2 id="idedetekt"><code>IDE</code>接入<code>DeteKt</code>插件</h2>
<p>如果能在<code>IDE</code>中提示代码中存在的问题，应该是最快发现问题的方式，<code>DeteKt</code>也贴心的为我们准备了插件，如下所示：</p>
<p><img alt="" src="https://raw.gitmirror.com/RicardoJiang/resource/main/2023/july/p14.webp" /></p>
<p>主要可以配置以下内容：  <br />
1. <code>DeteKt</code>开关
2. 格式化开关，<code>DeteKt</code>直接使用了<code>ktlint</code>的规则
3. <code>Configuration file</code>：规则配置文件，可以在其中配置各种规则的开关与参数，默认配置可见：<a href="https://github.com/detekt/detekt/blob/main/detekt-core/src/main/resources/default-detekt-config.yml">default-detekt-config.yml</a>
4. <code>Baseline file</code>：基线文件，跳过旧代码问题，有了这个基线文件，下次扫描时，就会绕过文件中列出的基线问题，而只提示新增问题。
5. <code>Plugin jar</code>: 自定义规则<code>jar</code>包，在自定义规则后打出<code>jar</code>包，在扫描时就可以使用自定义规则了</p>
<p><code>DeteKt IDE</code>插件可以实时提示问题(包括自定义规则)，如下图所示，我们添加了自定义禁止使用<code>kae</code>的规则：  </p>
<p><img alt="" src="https://raw.gitmirror.com/RicardoJiang/resource/main/2023/july/p15.webp" /></p>
<p>对于一些支持自动修复的格式问题，<code>DeteKt</code>插件支持自动格式化，同时也可以配置快捷键，一键自动格式化，如下所示：</p>
<p><img alt="" src="https://raw.gitmirror.com/RicardoJiang/resource/main/2023/july/p16.webp" /></p>
<h2 id="clidetekt"><code>CLI</code>命令行方式接入<code>DeteKt</code></h2>
<p><code>DeteKt</code>支持通过<code>CLI</code>命令行方式接入，支持只检测几个文件，比如本次<code>commit</code>提交的文件</p>
<p>我们可以通过如下方式，下载<code>DeteKt</code>的<code>jar</code>然后使用</p>
<pre><code>curl -sSLO https://github.com/detekt/detekt/releases/download/v1.22.0-RC1/detekt-cli-1.22.0-RC1.zip
unzip detekt-cli-1.22.0-RC1.zip
./detekt-cli-1.22.0-RC1/bin/detekt-cli --help
</code></pre>
<p><code>DeteKt CLI</code>支持很多参数，下面列出一些常用的，其他可以参见：<a href="https://detekt.dev/docs/gettingstarted/cli">Run detekt using Command Line Interface</a></p>
<pre><code>Usage: detekt [options]
  Options:
    --auto-correct, -ac
      支持自动格式化的规则自动格式化，默认为false
      Default: false
    --baseline, -b
      如果传入了baseline文件，只有不在baseline文件中的问题才会掘出来
    --classpath, -cp
      实验特性：传入依赖的class路径和jar的路径，用于类型解析
    --config, -c
      规则配置文件，可以配置规则开关及参数
    --create-baseline, -cb
      创建baseline，默认false，如果开启会创建出一个baseline文件，供后续使用
    --input, -i
      输入文件路径，多个路径之间用逗号连接
    --jvm-target
      EXPERIMENTAL: Target version of the generated JVM bytecode that was 
      generated during compilation and is now being used for type resolution 
      (1.6, 1.8, 9, 10, 11, 12, 13, 14, 15, 16 or 17)
      Default: 1.8
    --language-version
      为支持类型解析，需要传入java版本
    --plugins, -p
      自定义规则jar路径，多个路径之间用,或者;连接
</code></pre>
<p>在命令行可以直接通过如下方式检查</p>
<pre><code>java -jar /path/to/detekt-cli-1.21.0-all.jar # detekt-cli-1.21.0-all.jar所在路径
-c /path/to/detekt_1.21.0_format.yml # 规则配置文件所在路径
--plugins /path/to/detekt-formatting-1.21.0.jar # 格式化规则jar，主要基于ktlint封装
-ac # 开启自动格式化
-i $FilePath$ # 需要扫描的源文件，多个路径之间用,或者;连接
</code></pre>
<p>通过如上方式进行代码检查速度是非常快的，根据经验来说一般就是几秒之内可以完成，因此我们完成可以将<code>DeteKt</code>与<code>git hook</code>结合起来，在每次提交<code>commit</code>的时候进行检测，而如果是一些比较耗时的工具比如<code>lint</code>，应该是做不到这一点的</p>
<h3 id="_2">类型解析</h3>
<p>上面我们提到了，<code>DeteKt</code>的<code>--classpth</code>参数与<code>--language-version</code>参数，这些是用于类型解析的。</p>
<p>类型解析是<code>DeteKt</code>的一项功能，它允许 <code>Detekt</code> 对您的 <code>Kotlin</code> 源代码执行更高级的静态分析。</p>
<p>通常，<code>Detekt</code> 在编译期间无法访问编译器语义分析的结果，我们只能获取<code>Kotlin</code>源代码的抽象语法树，却无法知道语法树上符号的语义，这限制了我们的检查能力，比如我们无法判断符号的类型，两个符号究竟是不是同一个对象等</p>
<p>通过启用类型解析，<code>Detekt</code> 可以获取<code>Kotlin</code>编译器语义分析的结果，这让我们可以自定义一些更高级的检查。</p>
<p>而要获取类型与语义，当然要传入依赖的<code>class</code>，也就是<code>classpath</code>，比如<code>android</code>项目中常常需要传入<code>android.jar</code>与<code>kotlin-stdlib.jar</code></p>
<h2 id="gradledetekt"><code>Gradle</code>方式接入<code>DeteKt</code></h2>
<p><code>CLI</code>方式检测虽然快，但是需要手动传入<code>classpath</code>，比较麻烦，尤其是有时候自定义规则需要解析我们自己的类而不是<code>kotlin-stdlib.jar</code>中的类时，那么就需要将项目中的代码的编译结果传入作为<code>classpath</code>了，这样就更麻烦了</p>
<p><code>DeteKt</code>同样支持<code>Gradle</code>插件方式接入，这种方式不需要我们另外再配置<code>classpath</code>，我们可以将<code>CLI</code>命令行方式与<code>Gradle</code>方式结合起来，在本地通过<code>CLI</code>方式快速检测，在<code>CI</code>上通过<code>Gradle</code>插件进行完整的检测</p>
<h3 id="_3">接入步骤</h3>
<pre><code>// 1. 引入插件
plugins {
    id(&quot;io.gitlab.arturbosch.detekt&quot;).version(&quot;[version]&quot;)
}

repositories {
    mavenCentral()
}

// 2. 配置插件
detekt {
    config = files(&quot;$projectDir/config/detekt.yml&quot;) // 规则配置
    baseline = file(&quot;$projectDir/config/baseline.xml&quot;) // baseline配置
    parallel = true
}

// 3. 自定义规则
dependencies {
    detektPlugins &quot;io.gitlab.arturbosch.detekt:detekt-formatting:1.21.0&quot;
    detektPlugins project(&quot;:customRules&quot;)
}

// 4. 配置 jvmTarget
tasks.withType(Detekt).configureEach {
    jvmTarget = &quot;1.8&quot;
}
// DeteKt Task用于检测，DetektCreateBaselineTask用于创建Baseline
tasks.withType(DetektCreateBaselineTask).configureEach {
    jvmTarget = &quot;1.8&quot;
}

// 5. 只分析指定文件
tasks.withType&lt;io.gitlab.arturbosch.detekt.Detekt&gt;().configureEach {
    // include(&quot;**/special/package/**&quot;) //  只分析 src/main/kotlin 下面的指定目录文件
    exclude(&quot;**/special/package/internal/**&quot;) // 过滤指定目录
}

</code></pre>
<p>如上所示，接入主要需要做这么几件事：  </p>
<ol>
<li>引入插件</li>
<li>配置插件，主要是配置<code>config</code>与<code>baseline</code>，即规则开关与老代码过滤</li>
<li>引入<code>detekt-formatting</code>与自定义规则的依赖</li>
<li>配置<code>JvmTarget</code>，用于类型解析，但不用再配置<code>classpath</code>了。</li>
<li>除了<code>baseline</code>之外，也可以通过<code>include</code>与<code>exclude</code>的方式指定只扫描指定文件的方式来实现增量检测</li>
</ol>
<p>通过以上方式就接入成功了，运行<code>./gradlew detektDebug</code>就可以开始检测了，扫描结果可在终端直接查看，并可以直接定位到问题代码处，也可以在<code>build/reprots/</code>路径下查看输出的报告文件：</p>
<p><img alt="" src="https://raw.gitmirror.com/RicardoJiang/resource/main/2023/july/p17.webp" /></p>
<h2 id="detekt_1">自定义<code>Detekt</code>检测规则</h2>
<p>要落地自己制定的代码规范，不可避免的需要自定义规则，当然我们首先要看下<code>DeteKt</code>自带的规则，是否已经有我们需要的，只需把开关打开即可.</p>
<h3 id="detekt_2"><code>DeteKt</code>自带规则</h3>
<p><code>DeteKt</code>自带的规则都可以通过开关配置，如果没有在 <code>Detekt</code> 闭包中指定 <code>config</code> 属性，<code>detekt</code> 会使用默认的规则。这些规则采用 <code>yaml</code> 文件描述，运行 <code>./gradlew detektGenerateConfig</code> 会生成 <code>config/detekt/detekt.yml</code> 文件，我们可以在这个文件的基础上制定代码规范准则。</p>
<p><code>detekt.yml</code> 中的每条规则形如：</p>
<pre><code>complexity: # 大类
  active: true
  ComplexCondition: # 规则名
    active: true  # 是否启用
    threshold: 4  # 有些规则，可以设定一个阈值
# ...
</code></pre>
<p>更多关于配置文件的修改方式，请参考<a href="https://detekt.dev/docs/introduction/configurations">官方文档-配置文件</a></p>
<p><code>Detekt</code> 的规则集划分为 9 个大类，每个大类下有具体的规则：</p>
<table>
<thead>
<tr>
<th>规则大类</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>comments</td>
<td>与注释、文档有关的规范检查</td>
</tr>
<tr>
<td>complexity</td>
<td>检查代码复杂度，复杂度过高的代码不利于维护</td>
</tr>
<tr>
<td>coroutines</td>
<td>与协程有关的规范检查</td>
</tr>
<tr>
<td>empty-blocks</td>
<td>空代码块检查，空代码应该尽量避免</td>
</tr>
<tr>
<td>exceptions</td>
<td>与异常抛出和捕获有关的规范检查</td>
</tr>
<tr>
<td>formatting</td>
<td>格式化问题，detekt直接引用的 ktlint 的格式化规则集</td>
</tr>
<tr>
<td>naming</td>
<td>类名、变量命名相关的规范检查</td>
</tr>
<tr>
<td>performance</td>
<td>检查潜在的性能问题</td>
</tr>
<tr>
<td>potentail-bugs</td>
<td>检查潜在的BUG</td>
</tr>
<tr>
<td>style</td>
<td>统一团队的代码风格，也包括一些由 Detekt 定义的格式化问题</td>
</tr>
</tbody>
</table>
<p>表格引用自：<a href="https://cloud.tencent.com/developer/article/1811025">https://cloud.tencent.com/developer/article/1811025</a></p>
<p>更细节的规则说明，请参考：<a href="https://detekt.dev/docs/rules/comments">官方文档-规则集说明</a></p>
<h3 id="_4">自定义规则</h3>
<p>接下来我们自定义一个检测<code>KAE</code>使用的规则，如下所示： </p>
<pre><code class="language-kotlin">//  入口
class CustomRuleSetProvider : RuleSetProvider {
    override val ruleSetId: String = &quot;detekt-custom-rules&quot;
    override fun instance(config: Config): RuleSet = RuleSet(
        ruleSetId,
        listOf(
            NoSyntheticImportRule(),
        )
    )
}

// 自定义规则
class NoSyntheticImportRule : Rule() {
    override val issue = Issue(
        &quot;NoSyntheticImport&quot;,
        Severity.Maintainability,
        &quot;Don’t import Kotlin Synthetics as it is already deprecated.&quot;,
        Debt.TWENTY_MINS
    )

    override fun visitImportDirective(importDirective: KtImportDirective) {
        val import = importDirective.importPath?.pathStr
        if (import?.contains(&quot;kotlinx.android.synthetic&quot;) == true) {
            report(
                CodeSmell(
                    issue,
                    Entity.from(importDirective),
                    &quot;'$import' 不要使用kae，推荐使用viewbinding&quot;
                )
            )
        }
    }
}
</code></pre>
<p>代码其实并不复杂，主要做了这么几件事： <br />
1. 添加<code>CustomRuleSetProvider</code>作为自定义规则的入口，并将<code>NoSyntheticImportRule</code>添加进去
2. 实现<code>NoSyntheticImportRule</code>类，主要包括<code>issue</code>与各种<code>visitXXX</code>方法
3. <code>issue</code>属性用于定义在控制台或任何其他输出格式上打印的<code>ID</code>、严重性和提示信息
4. <code>visitImportDirective</code>即通过访问者模式访问语法树的回调，当访问到<code>import</code>时会回调，我们在这里检测有没有添加<code>kotlinx.android.synthetic</code>，发现存在则报告异常</p>
<h3 id="_5">支持类型解析的自定义规则</h3>
<p>上面的规则没有用到类型解析，也就是说不传入<code>classpath</code>也能使用，我们现在来看一个需要使用类型解析的自定义规则</p>
<p>比如我们需要在项目中禁止直接使用<code>android.widget.Toast.show</code>，而是使用我们统一封装的工具类，那么我们可以自定义如下规则：   </p>
<pre><code class="language-kotlin">class AvoidToUseToastRule : Rule() {
    override val issue = Issue(
        &quot;AvoidUseToastRule&quot;,
        Severity.Maintainability,
        &quot;Don’t use android.widget.Toast.show&quot;,
        Debt.TWENTY_MINS
    )

    override fun visitReferenceExpression(expression: KtReferenceExpression) {
        super.visitReferenceExpression(expression)
        if (expression.text == &quot;makeText&quot;) {
            // 通过bindingContext获取语义
            val referenceDescriptor = bindingContext.get(BindingContext.REFERENCE_TARGET, expression)
            val packageName = referenceDescriptor?.containingPackage()?.asString()
            val className = referenceDescriptor?.containingDeclaration?.name?.asString()
            if (packageName == &quot;android.widget&quot; &amp;&amp; className == &quot;Toast&quot;) {
                report(
                    CodeSmell(
                        issue, Entity.from(expression), &quot;禁止直接使用Toast，建议使用xxxUtils&quot;
                    )
                )
            }
        }
    }
}
</code></pre>
<p>可以看出，我们在<code>visitReferenceExpression</code>回调中检测表达式，我们不仅需要判断是否存在<code>Toast.makeTest</code>表达式，因为可能存在同名类，更需要判断<code>Toast</code>类的具体类型，而这就需要获取语义信息</p>
<p>我们这里通过<code>bindingContext</code>来获取表达式的语义，这里的<code>bindingContext</code>其实就是<code>Kotlin</code>编译器存储语义信息的表，详细的可以参阅：<a href="https://juejin.cn/post/7143207967775522823#heading-8">K2 编译器是什么？世界第二高峰又是哪座？</a></p>
<p>当我们获取了语义信息之后，就可以获取<code>Toast</code>的具体类型，就可以判断出这个<code>Toast</code>是不是<code>android.widget.Toast</code>，也就可以完成检测了</p>
<h2 id="github-actiondetekt"><code>Github Action</code>集成<code>Detekt</code>检测</h2>
<p>在完成了<code>DeteKt</code>接入与自定义规则之后，接下来就是每次提交代码时在<code>CI</code>上进行检测了</p>
<p>一些大的开源项目每次提交<code>PR</code>都会进行一系列的检测，我们也用<code>Github Action</code>来实现一个</p>
<p>我们在<code>.github/workflows</code>目录添加如下代码</p>
<pre><code>name: Android CI

on:
  push:
    branches: [ &quot;main&quot; ]
  pull_request:
    branches: [ &quot;main&quot; ]

jobs:
  detekt-code-check:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    - name: DeteKt Code Check
      run: ./gradlew detektDebug
</code></pre>
<p>这样在每次提交<code>PR</code>的时候，就都会自动调用该<code>workflow</code>进行检测了，检测不通过则不允许合并，如下所示：  </p>
<p><img alt="" src="https://raw.gitmirror.com/RicardoJiang/resource/main/2023/july/p18.webp" /></p>
<p>点进去也可以看到详细的报错，具体是哪一行代码检测不通过，如图所示：</p>
<p><img alt="" src="https://raw.gitmirror.com/RicardoJiang/resource/main/2023/july/p19.webp" /></p>
<h2 id="_6">总结</h2>
<p>本文主要介绍了<code>DeteKt</code>的接入与如何自定义规则，通过<code>IDE</code>集成，<code>CLI</code>命令行方式与<code>Gradle</code>插件方式接入，以及<code>CI</code>自动检测，可以保证代码规范，<code>IDE</code>提示，<code>CI</code>检测三者的统一，方便提前暴露问题，提高代码质量。</p>
<p>如果本文对你有所帮助，欢迎点赞~</p>
<h3 id="_7">示例代码</h3>
<p>本文所有代码可见：<a href="https://github.com/RicardoJiang/android-workflow">https://github.com/RicardoJiang/android-workflow</a></p>
<h3 id="_8">参考资料</h3>
<p><a href="https://detekt.dev/docs/intro">https://detekt.dev/docs/intro</a>         <br />
<a href="https://cloud.tencent.com/developer/article/1811025">代码质量堪忧？用 detekt 呀，拿捏得死死的~</a></p>

  <hr>
<div class="md-source-file">
  <small>
    
      最后更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">July 16, 2023</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../compile/now-in-android/" class="md-footer__link md-footer__link--prev" aria-label="上一页: nowinandroid 构建脚本学习" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                nowinandroid 构建脚本学习
              </div>
            </div>
          </a>
        
        
          
          <a href="../../stability/airbag/" class="md-footer__link md-footer__link--next" aria-label="下一页: 安全气囊如何实现？" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                安全气囊如何实现？
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.a51614de.min.js"></script>
      
    
  </body>
</html>